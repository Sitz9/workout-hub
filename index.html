<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Markus' Workout Hub</title>
  <meta name="description" content="Dein schneller Workout-Guide mit Videos, Timer und Routinen.">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg:#0b0b0c; --card:#141416; --border:#232327; --text:#f2f2f2; --muted:#a1a1aa; }
    [data-theme="light"] { --bg:#fafafa; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#6b7280; }
    html, body { height:100%; background:var(--bg); color:var(--text); }
    .card { border-radius: 1.25rem; border:1px solid var(--border); background:var(--card); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:1rem; padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); white-space:nowrap; flex:0 0 auto; }
    .btn:hover { background:rgba(255,255,255,.06); }
    .btn-primary { background:#111; color:#fff; border-color:#111; }
    .btn-danger { background:#dc2626; color:#fff; border-color:#dc2626; }
    .chip { padding:.44rem .8rem; border-radius:999px; border:1px solid var(--border); font-size:.9rem; }
    .chip.active { background:#111; color:#fff; border-color:#111; }
    .aspect-video { position: relative; padding-bottom:56.25%; height:0; }
    .aspect-video iframe { position:absolute; top:0; left:0; width:100%; height:100%; border:0; border-radius:.75rem; }
    .grid-cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1rem; }
    .safe { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
    .maxwrap { max-width: 1560px; }
    .drawer { position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; z-index:60; }
    .drawer.open { display:block; }
    .drawer-panel { position:absolute; right:0; top:0; bottom:0; width: 340px; max-width: 90vw; background:var(--card); border-left:1px solid var(--border); padding:1rem; padding-top: calc(1rem + env(safe-area-inset-top)); overflow:auto; }
  </style>
</head>
<body class="min-h-full safe">
  <header class="sticky top-0 z-20 backdrop-blur bg-[color:var(--card)]/90 border-b border-[color:var(--border)]">
    <div class="maxwrap mx-auto px-4 py-3 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <span class="inline-flex w-8 h-8 items-center justify-center rounded-xl bg-black text-white">ğŸ‹ï¸</span>
        <h1 class="text-xl md:text-2xl font-bold truncate">Markus' Workout Hub</h1>
        <span class="hidden md:inline text-xs ml-2 rounded-full bg-white/10 px-2 py-1">Videos Â· Timer Â· Routinen</span>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="btnFilter" class="btn">ğŸ” Filter</button>
        <label class="relative">
          <input id="search" placeholder="Suche Ãœbungen/Equipment..." class="pl-3 pr-3 py-2 rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] w-56 md:w-80 focus:outline-none focus:ring-2 focus:ring-black" />
        </label>
        <button id="btnExport" class="btn">â¬‡ï¸ Export</button>
        <label class="btn cursor-pointer">â¬†ï¸ Import
          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnAdd" class="btn btn-primary">ï¼‹ Ãœbung</button>
        <button id="btnTheme" class="btn" title="Dark/Light">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main class="maxwrap mx-auto px-4 py-6 grid gap-6" style="grid-template-columns: 2fr 1fr;">
    <!-- Ãœbungen -->
    <section class="space-y-3">
      <h2 class="font-semibold">Ãœbungen <span id="exercise-count" class="text-[color:var(--muted)]"></span></h2>
      <div id="exercise-list" class="grid-cards"></div>
    </section>

    <!-- Routinen & Timer -->
    <section class="space-y-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span>ğŸ—‚ï¸</span><h2 class="font-semibold">Schnell-Routinen</h2>
        </div>
        <div id="routine-list" class="space-y-2"></div>
      </div>

      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span>â±ï¸</span><h2 class="font-semibold">Timer</h2>
        </div>
        <div id="timer-empty" class="text-sm text-[color:var(--muted)]">WÃ¤hle eine Routine und starte den Timer.</div>
        <div id="timer-ui" class="hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm text-[color:var(--muted)]">Aktuell</p>
              <p id="timer-current" class="font-semibold truncate"></p>
              <p id="timer-step" class="text-xs text-[color:var(--muted)]"></p>
            </div>
            <div id="timer-remaining" class="text-4xl font-bold tabular-nums">0s</div>
          </div>
          <div id="timer-video" class="aspect-video hidden"></div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="btnToggle" class="btn">â–¶ï¸ Start</button>
            <button id="btnReset" class="btn">ğŸ” Reset</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Filter Drawer -->
  <div id="drawer" class="drawer">
    <div class="drawer-panel">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Filter</h3>
        <button id="btnCloseDrawer" class="btn">âœ–ï¸</button>
      </div>
      <div class="space-y-4">
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Muskelgruppen</p>
          <div id="filter-groups" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Schwierigkeit</p>
          <div id="filter-diff" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Equipment</p>
          <div id="filter-equip" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="pt-2 flex gap-2">
          <button id="btnResetFilters" class="btn">â†º ZurÃ¼cksetzen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add/Edit Ãœbung -->
  <dialog id="modal" class="w-full max-w-xl rounded-2xl p-0 border border-[color:var(--border)] shadow-xl bg-[color:var(--card)] text-[color:var(--text)]">
    <form method="dialog" class="p-4 space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><span>ğŸ› ï¸</span><h3 id="modalTitle" class="font-semibold">Ãœbung bearbeiten</h3></div>
        <button id="modalClose" class="btn">âœ–ï¸</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <label class="text-sm">Name
          <input id="f-name" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="z.B. Plank">
        </label>
        <label class="text-sm">Schwierigkeit
          <select id="f-diff" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2">
            <option>Einsteiger</option>
            <option>Fortgeschritten</option>
            <option>Profi</option>
          </select>
        </label>
        <fieldset class="sm:col-span-2">
          <p class="text-sm mb-1">Muskelgruppen</p>
          <div id="f-groups" class="flex flex-wrap gap-2"></div>
        </fieldset>
        <label class="text-sm sm:col-span-2">Equipment
          <input id="f-equip" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="z.B. Keine / Kurzhanteln / Band">
        </label>
        <label class="text-sm sm:col-span-2">Video-Link (YouTube/Vimeo)
          <input id="f-video" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="https://www.youtube.com/watch?v=...">
          <p class="text-xs mt-1 text-[color:var(--muted)]">Tipp: Du kannst die normale YouTube-URL einfÃ¼gen â€“ sie wird automatisch fÃ¼rs Einbetten umgewandelt.</p>
        </label>
        <label class="text-sm sm:col-span-2">Cues (je Zeile eine)
          <textarea id="f-cues" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" rows="3" placeholder="Atme ruhig&#10;RÃ¼cken neutral&#10;Knie stabil"></textarea>
        </label>
        <label class="text-sm sm:col-span-2">Ablauf-Schritte (je Zeile eine)
          <textarea id="f-steps" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" rows="4" placeholder="Ausgangsposition einnehmen&#10;Kontrolliert absenken&#10;Explosiv hochdrÃ¼cken"></textarea>
        </label>
      </div>
      <div class="flex justify-end">
        <button id="f-save" class="btn btn-primary" value="default">ğŸ’¾ Speichern</button>
      </div>
    </form>
  </dialog>

  <footer class="maxwrap mx-auto px-4 py-8 text-center text-xs text-[color:var(--muted)]">
    âš¡ï¸ OfflinefÃ¤hig & installierbar. Daten bleiben lokal (localStorage). â€“ FÃ¼r Markus
  </footer>

  <script>
    // ----- Theme toggle -----
    const THEME_KEY = 'markus_theme';
    function applyTheme(v){ document.documentElement.setAttribute('data-theme', v); }
    function getTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
    function setTheme(v){ localStorage.setItem(THEME_KEY, v); applyTheme(v); }
    applyTheme(getTheme());
    document.getElementById('btnTheme').onclick = () => setTheme(getTheme()==='light' ? 'dark' : 'light');

    // ----- Data & Storage -----
    const LS_EX = 'markus_workout_exercises_v1';
    const LS_RT = 'markus_workout_routines_v1';

    const DEFAULT_EXERCISES = [
      { id:'squat', name:'Kniebeuge (Bodyweight)', groups:['Beine','Core'], difficulty:'Einsteiger', equipment:'Keine', videoUrl:'', cues:['Fersen am Boden','Knie folgen den Zehen','Brust stolz'], steps:['Stand schulterbreit, FÃ¼ÃŸe leicht nach auÃŸen.','HÃ¼fte nach hinten, dann Knie beugen, bis Oberschenkel mind. parallel.','Druck Ã¼ber die Fersen nach oben, GesÃ¤ÃŸ anspannen.'] },
      { id:'pushup', name:'LiegestÃ¼tz', groups:['Arme','Brust','Core'], difficulty:'Einsteiger', equipment:'Keine', videoUrl:'', cues:['KÃ¶rper in Linie','Ellbogen ~45Â°','Bauch fest'], steps:['HÃ¤nde unter den Schultern, KÃ¶rperspannung.','Kontrolliert absenken bis Brust kurz vor Boden.','Kraftvoll nach oben drÃ¼cken.'] },
      { id:'hiphinge', name:'Hip Hinge (HÃ¼ftbeuge)', groups:['RÃ¼cken','Beine','Core'], difficulty:'Einsteiger', equipment:'Keine / Hantel optional', videoUrl:'', cues:['RÃ¼cken neutral','HÃ¼fte nach hinten','Gewicht nah am KÃ¶rper'], steps:['Leichter Stand, Knie sanft beugen.','HÃ¼fte weit nach hinten schieben.','Bei Dehnung wieder aufrichten.'] },
      { id:'row', name:'Ruderzug vorgebeugt (mit Band)', groups:['RÃ¼cken','Arme'], difficulty:'Einsteiger', equipment:'Widerstandsband', videoUrl:'', cues:['Schultern unten','Ellbogen am KÃ¶rper','Oben kurz halten'], steps:['Band fixieren, Enden greifen.','OberkÃ¶rper leicht vor, Bauch fest.','Ellbogen zurÃ¼ckziehen, SchulterblÃ¤tter zusammen.'] },
      { id:'split_squat', name:'Bulgarian Split Squat', groups:['Beine','Core'], difficulty:'Fortgeschritten', equipment:'Bank/Stuhl', videoUrl:'', cues:['Vorderes Knie stabil','OberkÃ¶rper aufrecht','Ferse drÃ¼ckt'], steps:['RÃ¼ckenfuÃŸ erhÃ¶ht auf Bank.','Absenken bis vorderer Oberschenkel parallel.','Ãœber die Ferse nach oben.'] },
    ];

    const DEFAULT_ROUTINES = [
      { id:'pre_shower_legs', name:'Vor-der-Dusche: Beine 12 Min', description:'Kurz & knackig fÃ¼r die Beine.', blocks:[
        {type:'exercise', exerciseId:'squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'split_squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'split_squat', secs:40},{type:'rest',secs:60},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:60},
      ]},
      { id:'pre_shower_arms_back', name:'Vor-der-Dusche: Arme & RÃ¼cken 13 Min', description:'Push/Pull-Mix mit Core.', blocks:[
        {type:'exercise', exerciseId:'pushup', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'row', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'pushup', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'row', secs:40},{type:'rest',secs:60},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:60},
      ]},
    ];

    function load(key, fallback) {
      try { const v = JSON.parse(localStorage.getItem(key)); return Array.isArray(v) ? v : fallback; } catch { return fallback; }
    }
    function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    let exercises = load(LS_EX, DEFAULT_EXERCISES);
    let routines  = load(LS_RT, DEFAULT_ROUTINES);

    // ----- UI Refs -----
    const elSearch = document.getElementById('search');
    const elList   = document.getElementById('exercise-list');
    const elCount  = document.getElementById('exercise-count');
    const elBtnAdd = document.getElementById('btnAdd');
    const elBtnExport = document.getElementById('btnExport');
    const elFileImport = document.getElementById('fileImport');
    const elBtnFilter = document.getElementById('btnFilter');
    const elDrawer = document.getElementById('drawer');
    const elCloseDrawer = document.getElementById('btnCloseDrawer');
    const elResetFilters = document.getElementById('btnResetFilters');

    const groupOptions = ['Beine','Arme','RÃ¼cken','Brust','Core'];
    const diffOptions  = ['Einsteiger','Fortgeschritten','Profi'];
    const equipOptions = () => [...new Set(exercises.map(e => e.equipment))];

    const filters = { groups: new Set(), difficulty: new Set(), equipment: new Set() };

    function chip(label, active, onClick) {
      const b = document.createElement('button');
      b.className = 'chip' + (active ? ' active' : '');
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }

    function renderFilters() {
      const gRoot = document.getElementById('filter-groups');
      const dRoot = document.getElementById('filter-diff');
      const eRoot = document.getElementById('filter-equip');
      gRoot.innerHTML = ''; dRoot.innerHTML = ''; eRoot.innerHTML = '';

      groupOptions.forEach(g => gRoot.appendChild(chip(g, filters.groups.has(g), () => { toggleFilter('groups', g); })));
      diffOptions.forEach(d => dRoot.appendChild(chip(d, filters.difficulty.has(d), () => { toggleFilter('difficulty', d); })));
      equipOptions().forEach(e => eRoot.appendChild(chip(e, filters.equipment.has(e), () => { toggleFilter('equipment', e); })));
    }
    function toggleFilter(key, val) {
      const set = filters[key];
      set.has(val) ? set.delete(val) : set.add(val);
      renderExercises(); renderFilters();
    }
    function resetFilters(){
      filters.groups.clear(); filters.difficulty.clear(); filters.equipment.clear();
      renderExercises(); renderFilters();
    }

    function toEmbed(url) {
      if (!url) return '';
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtube.com')) { const v = u.searchParams.get('v'); if (v) return `https://www.youtube.com/embed/${v}`; }
        if (u.hostname === 'youtu.be') { return `https://www.youtube.com/embed/${u.pathname.replace('/', '')}`; }
        if (u.hostname.includes('vimeo.com')) { const id = u.pathname.split('/').filter(Boolean).pop(); if (id) return `https://player.vimeo.com/video/${id}`; }
        return url;
      } catch { return url; }
    }

    function renderExercises() {
      const q = elSearch.value.trim().toLowerCase();
      const items = exercises.filter(e => {
        if (q && !( (e.name + ' ' + e.groups.join(' ') + ' ' + e.equipment).toLowerCase().includes(q) )) return false;
        if (filters.groups.size && !e.groups.some(g => filters.groups.has(g))) return false;
        if (filters.difficulty.size && !filters.difficulty.has(e.difficulty)) return false;
        if (filters.equipment.size && !filters.equipment.has(e.equipment)) return false;
        return true;
      });
      elCount.textContent = `(${items.length})`;
      elList.innerHTML = '';
      items.forEach(e => {
        const card = document.createElement('div'); card.className = 'card p-4 h-full flex flex-col gap-3';
        const top = document.createElement('div'); top.className = 'flex items-start justify-between gap-3';
        const meta = document.createElement('div'); meta.className = 'min-w-0';
        meta.innerHTML = `<h3 class="font-semibold text-lg truncate" title="${e.name}">${e.name}</h3><p class="text-sm text-[color:var(--muted)]">${e.groups.join(' Â· ')} Â· ${e.difficulty} Â· ${e.equipment}</p>`;
        const btns = document.createElement('div'); btns.className = 'flex items-center gap-2 flex-wrap justify-end';
        const bVideo = document.createElement('button'); bVideo.className = 'btn'; bVideo.textContent = 'â–¶ï¸ Video';
        const bEdit = document.createElement('button'); bEdit.className = 'btn'; bEdit.textContent = 'âœï¸ Bearbeiten';
        const bDel = document.createElement('button'); bDel.className = 'btn btn-danger'; bDel.textContent = 'ğŸ—‘ï¸ LÃ¶schen';
        btns.append(bVideo, bEdit, bDel); top.append(meta, btns); card.append(top);

        const details = document.createElement('div'); details.className = 'space-y-3 hidden';
        const vidWrap = document.createElement('div');
        if (e.videoUrl) {
          vidWrap.className = 'aspect-video';
          vidWrap.innerHTML = `<iframe src="${e.videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen title="${e.name}"></iframe>`;
        } else {
          vidWrap.className = 'p-4 rounded-xl border border-[color:var(--border)] bg-[color:var(--bg)] text-sm';
          vidWrap.textContent = 'Kein Video hinterlegt. Klicke auf â€âœï¸ Bearbeitenâ€œ und fÃ¼ge eine URL ein.';
        }
        details.appendChild(vidWrap);

        const cues = document.createElement('div');
        cues.innerHTML = `<p class="text-sm font-medium mb-1">Cues</p>`;
        const ul = document.createElement('ul'); ul.className = 'list-disc ml-5 text-sm text-[color:var(--muted)]';
        (e.cues||[]).forEach(c => { const li=document.createElement('li'); li.textContent = c; ul.appendChild(li); });
        cues.appendChild(ul); details.appendChild(cues);

        const steps = document.createElement('div');
        steps.innerHTML = `<p class="text-sm font-medium mb-1">Ablauf</p>`;
        const ol = document.createElement('ol'); ol.className = 'list-decimal ml-5 text-sm text-[color:var(--muted)]';
        (e.steps||[]).forEach(s => { const li=document.createElement('li'); li.textContent = s; ol.appendChild(li); });
        steps.appendChild(ol); details.appendChild(steps);
        card.append(details);

        let open = false;
        bVideo.onclick = () => { open = !open; details.classList.toggle('hidden', !open); };
        bEdit.onclick = () => openEditModal(e.id);
        bDel.onclick = () => {
          if (!confirm('Ãœbung wirklich lÃ¶schen?')) return;
          exercises = exercises.filter(x => x.id !== e.id);
          // remove from routines
          routines = routines.map(r => ({...r, blocks: r.blocks.filter(b => b.type !== 'exercise' || b.exerciseId !== e.id)}));
          save(LS_EX, exercises); save(LS_RT, routines); renderExercises(); renderRoutines(); renderFilters();
        };

        elList.appendChild(card);
      });
    }

    // ----- Routines & Timer -----
    const elRoutines = document.getElementById('routine-list');
    const elTimerEmpty = document.getElementById('timer-empty');
    const elTimerUI = document.getElementById('timer-ui');
    const elTimerCurrent = document.getElementById('timer-current');
    const elTimerStep = document.getElementById('timer-step');
    const elTimerRemaining = document.getElementById('timer-remaining');
    const elTimerVideo = document.getElementById('timer-video');
    const elBtnToggle = document.getElementById('btnToggle');
    const elBtnReset = document.getElementById('btnReset');

    let activeRoutine = null, timerIdx = 0, remaining = 0, tick = null, running = false;

    function renderRoutines() {
      elRoutines.innerHTML = '';
      routines.forEach(r => {
        const row = document.createElement('div'); row.className = 'flex items-center justify-between p-3 rounded-xl border border-[color:var(--border)]';
        const info = document.createElement('div');
        info.innerHTML = `<p class="font-medium">${r.name}</p><p class="text-xs text-[color:var(--muted)]">${r.description||''}</p>`;
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = 'â–¶ï¸ Start';
        btn.onclick = () => startRoutine(r);
        row.append(info, btn); elRoutines.appendChild(row);
      });
    }

    function startRoutine(r) {
      activeRoutine = r; timerIdx = 0; remaining = r.blocks[0]?.secs || 0; running = true;
      elTimerEmpty.classList.add('hidden'); elTimerUI.classList.remove('hidden');
      elBtnToggle.textContent = 'â¸ï¸ Pause';
      updateTimerUI(); startTick();
    }

    function startTick() {
      stopTick();
      tick = setInterval(() => {
        if (!running) return;
        remaining -= 1;
        if (remaining <= 0) nextBlock();
        updateTimerUI();
      }, 1000);
    }
    function stopTick(){ if (tick) { clearInterval(tick); tick = null; } }

    function nextBlock() {
      timerIdx += 1;
      if (!activeRoutine || timerIdx >= activeRoutine.blocks.length) {
        running = false; stopTick(); remaining = 0;
        elBtnToggle.textContent = 'â–¶ï¸ Start';
        return;
      }
      const blk = activeRoutine.blocks[timerIdx];
      remaining = blk.secs;
    }

    function resetTimer() {
      if (!activeRoutine) return;
      timerIdx = 0; remaining = activeRoutine.blocks[0]?.secs || 0; running = false; stopTick();
      elBtnToggle.textContent = 'â–¶ï¸ Start';
      updateTimerUI();
    }

    function updateTimerUI() {
      if (!activeRoutine) return;
      const blk = activeRoutine.blocks[timerIdx];
      const isExercise = blk?.type === 'exercise';
      elTimerCurrent.textContent = isExercise ? (exercises.find(e => e.id === blk.exerciseId)?.name || 'Ãœbung') : 'Pause';
      elTimerStep.textContent = `Schritt ${timerIdx + 1} / ${activeRoutine.blocks.length}`;
      elTimerRemaining.textContent = Math.max(0, remaining) + 's';

      elTimerVideo.innerHTML = ''; elTimerVideo.classList.add('hidden');
      if (isExercise) {
        const ex = exercises.find(e => e.id === blk.exerciseId);
        if (ex && ex.videoUrl) {
          elTimerVideo.classList.remove('hidden');
          const wrap = document.createElement('div'); wrap.className = 'aspect-video';
          wrap.innerHTML = `<iframe src="${ex.videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
          elTimerVideo.appendChild(wrap);
        }
      }
    }

    elBtnToggle.onclick = () => { if (!activeRoutine) return;
      running = !running; elBtnToggle.textContent = running ? 'â¸ï¸ Pause' : 'â–¶ï¸ Start'; if (running) startTick();
    };
    elBtnReset.onclick = resetTimer;

    // ----- Add/Edit Modal -----
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const fName = document.getElementById('f-name');
    const fDiff = document.getElementById('f-diff');
    const fGroups = document.getElementById('f-groups');
    const fEquip = document.getElementById('f-equip');
    const fVideo = document.getElementById('f-video');
    const fCues = document.getElementById('f-cues');
    const fSteps = document.getElementById('f-steps');
    const fSave = document.getElementById('f-save');
    let editingId = null;

    function renderGroupChipsForForm(selected = []) {
      fGroups.innerHTML = '';
      const chosen = new Set(selected);
      ['Beine','Arme','RÃ¼cken','Brust','Core'].forEach(g => {
        const b = document.createElement('button');
        b.className = 'chip' + (chosen.has(g) ? ' active' : '');
        b.textContent = g;
        b.onclick = (ev) => { ev.preventDefault(); if (chosen.has(g)) { chosen.delete(g); b.classList.remove('active'); } else { chosen.add(g); b.classList.add('active'); } };
        fGroups.appendChild(b);
      });
      return () => Array.from(chosen);
    }
    let getSelectedGroups = renderGroupChipsForForm();

    function openAddModal(){
      editingId = null;
      modalTitle.textContent = 'Neue Ãœbung anlegen';
      fName.value=''; fEquip.value='Keine'; fVideo.value=''; fCues.value=''; fSteps.value=''; fDiff.value='Einsteiger'; 
      getSelectedGroups = renderGroupChipsForForm([]);
      modal.showModal();
    }
    function openEditModal(id){
      const ex = exercises.find(x => x.id === id); if (!ex) return;
      editingId = id;
      modalTitle.textContent = 'Ãœbung bearbeiten';
      fName.value = ex.name; fEquip.value = ex.equipment; fVideo.value = ex.videoUrl; fDiff.value = ex.difficulty;
      fCues.value = (ex.cues||[]).join('\n'); fSteps.value = (ex.steps||[]).join('\n');
      getSelectedGroups = renderGroupChipsForForm(ex.groups||[]);
      modal.showModal();
    }

    document.getElementById('btnAdd').onclick = openAddModal;
    modalClose.onclick = (e) => { e.preventDefault(); modal.close(); };

    fSave.onclick = (e) => {
      e.preventDefault();
      const name = fName.value.trim(); if (!name) { alert('Bitte Namen eingeben'); return; }
      const payload = {
        name,
        groups: getSelectedGroups(),
        difficulty: fDiff.value,
        equipment: fEquip.value || 'Keine',
        videoUrl: toEmbed(fVideo.value.trim()),
        cues: fCues.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
        steps: fSteps.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
      };
      if (editingId) {
        // Update existing (keep id to not break routines)
        exercises = exercises.map(x => x.id === editingId ? { ...x, ...payload } : x);
      } else {
        const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,40);
        if (exercises.some(x => x.id === id)) { alert('Diese Ãœbung existiert bereits.'); return; }
        exercises.push({ id, ...payload });
      }
      save(LS_EX, exercises); renderExercises(); renderFilters(); modal.close();
    };

    // ----- Import/Export -----
    elBtnExport.onclick = () => {
      const payload = { exercises, routines };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'markus_workouts.json'; a.click(); URL.revokeObjectURL(url);
    };
    elFileImport.onchange = (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (Array.isArray(data.exercises) && Array.isArray(data.routines)) {
            exercises = data.exercises; routines = data.routines; save(LS_EX, exercises); save(LS_RT, routines);
            renderExercises(); renderRoutines(); renderFilters();
          } else alert('UngÃ¼ltige Datei');
        } catch { alert('Konnte JSON nicht lesen'); }
      };
      reader.readAsText(f);
      e.target.value = '';
    };

    // ----- Search -----
    elSearch.oninput = renderExercises;

    // ----- Filter Drawer events -----
    elBtnFilter.onclick = () => { renderFilters(); elDrawer.classList.add('open'); };
    elCloseDrawer.onclick = () => elDrawer.classList.remove('open');
    elDrawer.addEventListener('click', (e) => { if (e.target === elDrawer) elDrawer.classList.remove('open'); });
    elResetFilters.onclick = resetFilters;

    // ----- Init -----
    renderExercises(); renderRoutines(); renderFilters();

    // ----- PWA: Service Worker -----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }
  </script>
</body>
</html>
