<!doctype html>
<html lang="de" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Markus' Workout Hub</title>
  <meta name="description" content="Dein schneller Workout-Guide mit Videos, Timer und Routinen.">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --bg:#0b0b0c; --card:#141416; --border:#232327; --text:#f2f2f2; --muted:#a1a1aa; }
    [data-theme="light"] { --bg:#fafafa; --card:#fff; --border:#e5e7eb; --text:#111; --muted:#6b7280; }
    html, body { height:100%; background:var(--bg); color:var(--text); }
    .card { border-radius: 1.25rem; border:1px solid var(--border); background:var(--card); box-shadow:0 1px 2px rgba(0,0,0,.04); }
    .btn { display:inline-flex; align-items:center; gap:.5rem; border-radius:1rem; padding:.5rem 1rem; font-weight:600; border:1px solid var(--border); white-space:nowrap; flex:0 0 auto; }
    .btn:hover { background:rgba(255,255,255,.06); }
    .btn-primary { background:#111; color:#fff; border-color:#111; }
    .btn-danger { background:#dc2626; color:#fff; border-color:#dc2626; }
    .chip { padding:.44rem .8rem; border-radius:999px; border:1px solid var(--border); font-size:.9rem; }
    .chip.active { background:#111; color:#fff; border-color:#111; }
    .aspect-video { position: relative; padding-bottom:56.25%; height:0; }
    .aspect-video iframe { position:absolute; top:0; left:0; width:100%; height:100%; border:0; border-radius:.75rem; }
    .grid-cards { display:grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1rem; }
    .safe { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
    .maxwrap { max-width: 1560px; }
    .drawer { position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; z-index:60; }
    .drawer.open { display:block; }
    .drawer-panel { position:absolute; right:0; top:0; bottom:0; width: 360px; max-width: 90vw; background:var(--card); border-left:1px solid var(--border); padding:1rem; padding-top: calc(1rem + env(safe-area-inset-top)); overflow:auto; }
    /* Calendar styles */
    .cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:.5rem; }
    .cal-cell { border:1px solid var(--border); border-radius:.75rem; padding:.5rem; min-height:92px; background:var(--card); cursor:pointer; }
    .cal-cell:hover { outline:2px solid #3b82f6; outline-offset:0; }
    .cal-muted { color: var(--muted); opacity: .7; }
    .badge { font-size:.75rem; padding:.125rem .5rem; border-radius:.75rem; border:1px solid var(--border); display:inline-block; }
  </style>
</head>
<body class="min-h-full safe">
  <header class="sticky top-0 z-20 backdrop-blur bg-[color:var(--card)]/90 border-b border-[color:var(--border)]">
    <div class="maxwrap mx-auto px-4 py-3 flex flex-wrap gap-2 items-center justify-between">
      <div class="flex items-center gap-3 min-w-0">
        <span class="inline-flex w-8 h-8 items-center justify-center rounded-xl bg-black text-white">üèãÔ∏è</span>
        <h1 class="text-xl md:text-2xl font-bold truncate">Markus' Workout Hub</h1>
        <span class="hidden md:inline text-xs ml-2 rounded-full bg-white/10 px-2 py-1">Videos ¬∑ Timer ¬∑ Routinen</span>
      </div>
      <div class="flex items-center gap-2 flex-wrap">
        <button id="btnFilter" class="btn">üîé Filter</button>
        <label class="relative">
          <input id="search" placeholder="Suche √úbungen/Equipment..." class="pl-3 pr-3 py-2 rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] w-56 md:w-80 focus:outline-none focus:ring-2 focus:ring-black" />
        </label>
        <button id="btnCalendar" class="btn">üìÖ Kalender</button>
        <button id="btnExport" class="btn">‚¨áÔ∏è Export</button>
        <label class="btn cursor-pointer">‚¨ÜÔ∏è Import
          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </label>
        <button id="btnAdd" class="btn btn-primary">Ôºã √úbung</button>
        <button id="btnTheme" class="btn" title="Dark/Light">üåì</button>
      </div>
    </div>
  </header>

  <main class="maxwrap mx-auto px-4 py-6 grid gap-6" style="grid-template-columns: 2fr 1fr;">
    <!-- √úbungen -->
    <section class="space-y-3">
      <h2 class="font-semibold">√úbungen <span id="exercise-count" class="text-[color:var(--muted)]"></span></h2>
      <div id="exercise-list" class="grid-cards"></div>
    </section>

    <!-- Routinen & Timer -->
    <section class="space-y-4">
      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span>üóÇÔ∏è</span><h2 class="font-semibold">Schnell-Routinen</h2>
        </div>
        <div id="routine-list" class="space-y-2"></div>
      </div>

      <div class="card p-4">
        <div class="flex items-center gap-2 mb-3">
          <span>‚è±Ô∏è</span><h2 class="font-semibold">Timer</h2>
        </div>
        <div id="timer-empty" class="text-sm text-[color:var(--muted)]">W√§hle eine Routine und starte den Timer.</div>
        <div id="timer-ui" class="hidden space-y-3">
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <p class="text-sm text-[color:var(--muted)]">Aktuell</p>
              <p id="timer-current" class="font-semibold truncate"></p>
              <p id="timer-step" class="text-xs text-[color:var(--muted)]"></p>
            </div>
            <div id="timer-remaining" class="text-4xl font-bold tabular-nums">0s</div>
          </div>
          <div id="timer-video" class="aspect-video hidden"></div>
          <div class="flex items-center gap-2 flex-wrap">
            <button id="btnToggle" class="btn">‚ñ∂Ô∏è Start</button>
            <button id="btnReset" class="btn">üîÅ Reset</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Filter Drawer -->
  <div id="drawer" class="drawer">
    <div class="drawer-panel">
      <div class="flex items-center justify-between mb-2">
        <h3 class="font-semibold">Filter</h3>
        <button id="btnCloseDrawer" class="btn">‚úñÔ∏è</button>
      </div>
      <div class="space-y-4">
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Muskelgruppen</p>
          <div id="filter-groups" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Schwierigkeit</p>
          <div id="filter-diff" class="flex flex-wrap gap-2"></div>
        </div>
        <div>
          <p class="text-sm mb-2 text-[color:var(--muted)]">Equipment</p>
          <div id="filter-equip" class="flex flex-wrap gap-2"></div>
        </div>
        <div class="pt-2 flex gap-2">
          <button id="btnResetFilters" class="btn">‚Ü∫ Zur√ºcksetzen</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Add/Edit √úbung -->
  <dialog id="modal" class="w-full max-w-xl rounded-2xl p-0 border border-[color:var(--border)] shadow-xl bg-[color:var(--card)] text-[color:var(--text)]">
    <form method="dialog" class="p-4 space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2"><span>üõ†Ô∏è</span><h3 id="modalTitle" class="font-semibold">√úbung bearbeiten</h3></div>
        <button id="modalClose" class="btn">‚úñÔ∏è</button>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <label class="text-sm">Name
          <input id="f-name" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="z.B. Plank">
        </label>
        <label class="text-sm">Schwierigkeit
          <select id="f-diff" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2">
            <option>Einsteiger</option>
            <option>Fortgeschritten</option>
            <option>Profi</option>
          </select>
        </label>
        <fieldset class="sm:col-span-2">
          <p class="text-sm mb-1">Muskelgruppen</p>
          <div id="f-groups" class="flex flex-wrap gap-2"></div>
        </fieldset>
        <label class="text-sm sm:col-span-2">Equipment
          <input id="f-equip" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="z.B. Keine / Kurzhanteln / Band">
        </label>
        <label class="text-sm sm:col-span-2">Video-Link (YouTube/Vimeo)
          <input id="f-video" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" placeholder="https://www.youtube.com/watch?v=...">
          <p class="text-xs mt-1 text-[color:var(--muted)]">Tipp: Du kannst die normale YouTube-URL einf√ºgen ‚Äì sie wird automatisch f√ºrs Einbetten umgewandelt.</p>
        </label>
        <label class="text-sm sm:col-span-2">Cues (je Zeile eine)
          <textarea id="f-cues" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" rows="3" placeholder="Atme ruhig&#10;R√ºcken neutral&#10;Knie stabil"></textarea>
        </label>
        <label class="text-sm sm:col-span-2">Ablauf-Schritte (je Zeile eine)
          <textarea id="f-steps" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2" rows="4" placeholder="Ausgangsposition einnehmen&#10;Kontrolliert absenken&#10;Explosiv hochdr√ºcken"></textarea>
        </label>
      </div>
      <div class="flex justify-end">
        <button id="f-save" class="btn btn-primary" value="default">üíæ Speichern</button>
      </div>
    </form>
  </dialog>

  <!-- Modal: Calendar -->
  <dialog id="calModal" class="w-full max-w-4xl rounded-2xl p-0 border border-[color:var(--border)] shadow-xl bg-[color:var(--card)] text-[color:var(--text)]">
    <div class="p-4 space-y-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <button id="calPrev" class="btn">‚¨ÖÔ∏è</button>
          <h3 id="calTitle" class="font-semibold text-lg">Kalender</h3>
          <button id="calNext" class="btn">‚û°Ô∏è</button>
        </div>
        <button id="calClose" class="btn">‚úñÔ∏è</button>
      </div>
      <div class="grid grid-cols-7 text-center text-xs text-[color:var(--muted)]">
        <div>Mo</div><div>Di</div><div>Mi</div><div>Do</div><div>Fr</div><div>Sa</div><div>So</div>
      </div>
      <div id="calGrid" class="cal-grid"></div>
      <div class="text-xs text-[color:var(--muted)]">Tipp: Klick auf einen Tag, um einen Eintrag zu erstellen/zu bearbeiten.</div>
    </div>
  </dialog>

  <!-- Modal: Log Entry -->
  <dialog id="logModal" class="w-full max-w-2xl rounded-2xl p-0 border border-[color:var(--border)] shadow-xl bg-[color:var(--card)] text-[color:var(--text)]">
    <form method="dialog" class="p-4 space-y-4">
      <div class="flex items-center justify-between">
        <h3 id="logTitle" class="font-semibold">Training eintragen</h3>
        <button id="logClose" class="btn">‚úñÔ∏è</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm">Datum
            <input id="logDate" type="date" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2">
          </label>
          <label class="text-sm block mt-3">Dauer (Minuten)
            <input id="logDuration" type="number" min="0" step="1" placeholder="z. B. 30" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2">
          </label>
          <label class="text-sm block mt-3">Kalorien (optional)
            <input id="logCalories" type="number" min="0" step="1" placeholder="z. B. 250" class="mt-1 w-full rounded-xl border border-[color:var(--border)] bg-[color:var(--card)] px-3 py-2">
          </label>
        </div>
        <div>
          <p class="text-sm mb-1">√úbungen ausgew√§hlt</p>
          <div id="logExerciseList" class="max-h-56 overflow-auto border border-[color:var(--border)] rounded-xl p-2">
            <!-- checkboxes injected -->
          </div>
        </div>
      </div>

      <div>
        <p class="text-sm mb-1">Bisherige Eintr√§ge f√ºr den Tag</p>
        <div id="logExisting" class="space-y-2 text-sm"></div>
      </div>

      <div class="flex justify-end gap-2">
        <button id="logSave" class="btn btn-primary" value="default">üíæ Speichern</button>
      </div>
    </form>
  </dialog>

  <footer class="maxwrap mx-auto px-4 py-8 text-center text-xs text-[color:var(--muted)]">
    ‚ö°Ô∏è Offlinef√§hig & installierbar. Daten bleiben lokal (localStorage). ‚Äì F√ºr Markus
  </footer>

  <script>
    // ----- Theme toggle -----
    const THEME_KEY = 'markus_theme';
    function applyTheme(v){ document.documentElement.setAttribute('data-theme', v); }
    function getTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
    function setTheme(v){ localStorage.setItem(THEME_KEY, v); applyTheme(v); }
    applyTheme(getTheme());
    document.getElementById('btnTheme').onclick = () => setTheme(getTheme()==='light' ? 'dark' : 'light');

    // ----- Data & Storage -----
    const LS_EX = 'markus_workout_exercises_v1';
    const LS_RT = 'markus_workout_routines_v1';
    const LS_LOG = 'markus_workout_log_v1';

    const DEFAULT_EXERCISES = [
      { id:'squat', name:'Kniebeuge (Bodyweight)', groups:['Beine','Core'], difficulty:'Einsteiger', equipment:'Keine', videoUrl:'', cues:['Fersen am Boden','Knie folgen den Zehen','Brust stolz'], steps:['Stand schulterbreit, F√º√üe leicht nach au√üen.','H√ºfte nach hinten, dann Knie beugen, bis Oberschenkel mind. parallel.','Druck √ºber die Fersen nach oben, Ges√§√ü anspannen.'] },
      { id:'pushup', name:'Liegest√ºtz', groups:['Arme','Brust','Core'], difficulty:'Einsteiger', equipment:'Keine', videoUrl:'', cues:['K√∂rper in Linie','Ellbogen ~45¬∞','Bauch fest'], steps:['H√§nde unter den Schultern, K√∂rperspannung.','Kontrolliert absenken bis Brust kurz vor Boden.','Kraftvoll nach oben dr√ºcken.'] },
      { id:'hiphinge', name:'Hip Hinge (H√ºftbeuge)', groups:['R√ºcken','Beine','Core'], difficulty:'Einsteiger', equipment:'Keine / Hantel optional', videoUrl:'', cues:['R√ºcken neutral','H√ºfte nach hinten','Gewicht nah am K√∂rper'], steps:['Leichter Stand, Knie sanft beugen.','H√ºfte weit nach hinten schieben.','Bei Dehnung wieder aufrichten.'] },
      { id:'row', name:'Ruderzug vorgebeugt (mit Band)', groups:['R√ºcken','Arme'], difficulty:'Einsteiger', equipment:'Widerstandsband', videoUrl:'', cues:['Schultern unten','Ellbogen am K√∂rper','Oben kurz halten'], steps:['Band fixieren, Enden greifen.','Oberk√∂rper leicht vor, Bauch fest.','Ellbogen zur√ºckziehen, Schulterbl√§tter zusammen.'] },
      { id:'split_squat', name:'Bulgarian Split Squat', groups:['Beine','Core'], difficulty:'Fortgeschritten', equipment:'Bank/Stuhl', videoUrl:'', cues:['Vorderes Knie stabil','Oberk√∂rper aufrecht','Ferse dr√ºckt'], steps:['R√ºckenfu√ü erh√∂ht auf Bank.','Absenken bis vorderer Oberschenkel parallel.','√úber die Ferse nach oben.'] },
    ];

    const DEFAULT_ROUTINES = [
      { id:'pre_shower_legs', name:'Beine 12 Min', description:'Kurz & knackig f√ºr die Beine.', blocks:[
        {type:'exercise', exerciseId:'squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'split_squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'squat', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'split_squat', secs:40},{type:'rest',secs:60},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:60},
      ]},
      { id:'pre_shower_arms_back', name:'Arme & R√ºcken 13 Min', description:'Push/Pull-Mix mit Core.', blocks:[
        {type:'exercise', exerciseId:'pushup', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'row', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'pushup', secs:40},{type:'rest',secs:20},
        {type:'exercise', exerciseId:'row', secs:40},{type:'rest',secs:60},
        {type:'exercise', exerciseId:'hiphinge', secs:40},{type:'rest',secs:60},
      ]},
    ];

    function load(key, fallback) {
      try { const v = JSON.parse(localStorage.getItem(key)); return (key===LS_LOG ? (v||{}) : (Array.isArray(v) ? v : fallback)); } catch { return key===LS_LOG ? {} : fallback; }
    }
    function save(key, val) { localStorage.setItem(key, JSON.stringify(val)); }

    let exercises = load(LS_EX, DEFAULT_EXERCISES);
    let routines  = load(LS_RT, DEFAULT_ROUTINES);
    let logs = load(LS_LOG, {}); // { 'YYYY-MM-DD': [ {exercises:[], duration: 30, calories: 200, ts: 1700000000} ] }

    // ----- UI Refs -----
    const elSearch = document.getElementById('search');
    const elList   = document.getElementById('exercise-list');
    const elCount  = document.getElementById('exercise-count');
    const elBtnAdd = document.getElementById('btnAdd');
    const elBtnExport = document.getElementById('btnExport');
    const elFileImport = document.getElementById('fileImport');
    const elBtnFilter = document.getElementById('btnFilter');
    const elDrawer = document.getElementById('drawer');
    const elCloseDrawer = document.getElementById('btnCloseDrawer');
    const elResetFilters = document.getElementById('btnResetFilters');
    const elBtnCalendar = document.getElementById('btnCalendar');
    const calModal = document.getElementById('calModal');
    const calPrev = document.getElementById('calPrev');
    const calNext = document.getElementById('calNext');
    const calClose = document.getElementById('calClose');
    const calTitle = document.getElementById('calTitle');
    const calGrid = document.getElementById('calGrid');

    const logModal = document.getElementById('logModal');
    const logClose = document.getElementById('logClose');
    const logDate = document.getElementById('logDate');
    const logDuration = document.getElementById('logDuration');
    const logCalories = document.getElementById('logCalories');
    const logExerciseList = document.getElementById('logExerciseList');
    const logExisting = document.getElementById('logExisting');
    const logSave = document.getElementById('logSave');
    const logTitle = document.getElementById('logTitle');

    const groupOptions = ['Beine','Arme','R√ºcken','Brust','Core'];
    const diffOptions  = ['Einsteiger','Fortgeschritten','Profi'];
    const equipOptions = () => [...new Set(exercises.map(e => e.equipment))];

    const filters = { groups: new Set(), difficulty: new Set(), equipment: new Set() };

    function chip(label, active, onClick) {
      const b = document.createElement('button');
      b.className = 'chip' + (active ? ' active' : '');
      b.textContent = label;
      b.onclick = onClick;
      return b;
    }

    function renderFilters() {
      const gRoot = document.getElementById('filter-groups');
      const dRoot = document.getElementById('filter-diff');
      const eRoot = document.getElementById('filter-equip');
      gRoot.innerHTML = ''; dRoot.innerHTML = ''; eRoot.innerHTML = '';

      groupOptions.forEach(g => gRoot.appendChild(chip(g, filters.groups.has(g), () => { toggleFilter('groups', g); })));
      diffOptions.forEach(d => dRoot.appendChild(chip(d, filters.difficulty.has(d), () => { toggleFilter('difficulty', d); })));
      equipOptions().forEach(e => eRoot.appendChild(chip(e, filters.equipment.has(e), () => { toggleFilter('equipment', e); })));
    }

    function toggleFilter(key, val) {
      const set = filters[key];
      set.has(val) ? set.delete(val) : set.add(val);
      renderExercises(); renderFilters();
    }
    function resetFilters(){
      filters.groups.clear(); filters.difficulty.clear(); filters.equipment.clear();
      renderExercises(); renderFilters();
    }

    function toEmbed(url) {
      if (!url) return '';
      try {
        const u = new URL(url);
        if (u.hostname.includes('youtube.com')) { const v = u.searchParams.get('v'); if (v) return `https://www.youtube.com/embed/${v}`; }
        if (u.hostname === 'youtu.be') { return `https://www.youtube.com/embed/${u.pathname.replace('/', '')}`; }
        if (u.hostname.includes('vimeo.com')) { const id = u.pathname.split('/').filter(Boolean).pop(); if (id) return `https://player.vimeo.com/video/${id}`; }
        return url;
      } catch { return url; }
    }

    function renderExercises() {
      const q = elSearch.value.trim().toLowerCase();
      const items = exercises.filter(e => {
        if (q && !( (e.name + ' ' + e.groups.join(' ') + ' ' + e.equipment).toLowerCase().includes(q) )) return false;
        if (filters.groups.size && !e.groups.some(g => filters.groups.has(g))) return false;
        if (filters.difficulty.size && !filters.difficulty.has(e.difficulty)) return false;
        if (filters.equipment.size && !filters.equipment.has(e.equipment)) return false;
        return true;
      });
      elCount.textContent = `(${items.length})`;
      elList.innerHTML = '';
      items.forEach(e => {
        const card = document.createElement('div'); card.className = 'card p-4 h-full flex flex-col gap-3';
        const top = document.createElement('div'); top.className = 'flex items-start justify-between gap-3';
        const meta = document.createElement('div'); meta.className = 'min-w-0';
        meta.innerHTML = `<h3 class="font-semibold text-lg truncate" title="${e.name}">${e.name}</h3><p class="text-sm text-[color:var(--muted)]">${e.groups.join(' ¬∑ ')} ¬∑ ${e.difficulty} ¬∑ ${e.equipment}</p>`;
        const btns = document.createElement('div'); btns.className = 'flex items-center gap-2 flex-wrap justify-end';
        const bVideo = document.createElement('button'); bVideo.className = 'btn'; bVideo.textContent = '‚ñ∂Ô∏è Video';
        const bEdit = document.createElement('button'); bEdit.className = 'btn'; bEdit.textContent = '‚úèÔ∏è Bearbeiten';
        const bDel = document.createElement('button'); bDel.className = 'btn btn-danger'; bDel.textContent = 'üóëÔ∏è L√∂schen';
        btns.append(bVideo, bEdit, bDel); top.append(meta, btns); card.append(top);

        const details = document.createElement('div'); details.className = 'space-y-3 hidden';
        const vidWrap = document.createElement('div');
        if (e.videoUrl) {
          vidWrap.className = 'aspect-video';
          vidWrap.innerHTML = `<iframe src="${e.videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen title="${e.name}"></iframe>`;
        } else {
          vidWrap.className = 'p-4 rounded-xl border border-[color:var(--border)] bg-[color:var(--bg)] text-sm';
          vidWrap.textContent = 'Kein Video hinterlegt. Klicke auf ‚Äû‚úèÔ∏è Bearbeiten‚Äú und f√ºge eine URL ein.';
        }
        details.appendChild(vidWrap);

        const cues = document.createElement('div');
        cues.innerHTML = `<p class="text-sm font-medium mb-1">Cues</p>`;
        const ul = document.createElement('ul'); ul.className = 'list-disc ml-5 text-sm text-[color:var(--muted)]';
        (e.cues||[]).forEach(c => { const li=document.createElement('li'); li.textContent = c; ul.appendChild(li); });
        cues.appendChild(ul); details.appendChild(cues);

        const steps = document.createElement('div');
        steps.innerHTML = `<p class="text-sm font-medium mb-1">Ablauf</p>`;
        const ol = document.createElement('ol'); ol.className = 'list-decimal ml-5 text-sm text-[color:var(--muted)]';
        (e.steps||[]).forEach(s => { const li=document.createElement('li'); li.textContent = s; ol.appendChild(li); });
        steps.appendChild(ol); details.appendChild(steps);
        card.append(details);

        let open = false;
        bVideo.onclick = () => { open = !open; details.classList.toggle('hidden', !open); };
        bEdit.onclick = () => openEditModal(e.id);
        bDel.onclick = () => {
          if (!confirm('√úbung wirklich l√∂schen?')) return;
          exercises = exercises.filter(x => x.id !== e.id);
          // remove from routines
          routines = routines.map(r => ({...r, blocks: r.blocks.filter(b => b.type !== 'exercise' || b.exerciseId !== e.id)}));
          save(LS_EX, exercises); save(LS_RT, routines); renderExercises(); renderRoutines(); renderFilters();
        };

        elList.appendChild(card);
      });
    }

    // ----- Routines & Timer -----
    const elRoutines = document.getElementById('routine-list');
    const elTimerEmpty = document.getElementById('timer-empty');
    const elTimerUI = document.getElementById('timer-ui');
    const elTimerCurrent = document.getElementById('timer-current');
    const elTimerStep = document.getElementById('timer-step');
    const elTimerRemaining = document.getElementById('timer-remaining');
    const elTimerVideo = document.getElementById('timer-video');
    const elBtnToggle = document.getElementById('btnToggle');
    const elBtnReset = document.getElementById('btnReset');

    let activeRoutine = null, timerIdx = 0, remaining = 0, tick = null, running = false;

    function renderRoutines() {
      elRoutines.innerHTML = '';
      routines.forEach(r => {
        const row = document.createElement('div'); row.className = 'flex items-center justify-between p-3 rounded-xl border border-[color:var(--border)]';
        const info = document.createElement('div');
        info.innerHTML = `<p class="font-medium">${r.name}</p><p class="text-xs text-[color:var(--muted)]">${r.description||''}</p>`;
        const btn = document.createElement('button'); btn.className = 'btn'; btn.textContent = '‚ñ∂Ô∏è Start';
        btn.onclick = () => startRoutine(r);
        row.append(info, btn); elRoutines.appendChild(row);
      });
    }

    function startRoutine(r) {
      activeRoutine = r; timerIdx = 0; remaining = r.blocks[0]?.secs || 0; running = true;
      elTimerEmpty.classList.add('hidden'); elTimerUI.classList.remove('hidden');
      elBtnToggle.textContent = '‚è∏Ô∏è Pause';
      updateTimerUI(); startTick();
    }

    function startTick() {
      stopTick();
      tick = setInterval(() => {
        if (!running) return;
        remaining -= 1;
        if (remaining <= 0) nextBlock();
        updateTimerUI();
      }, 1000);
    }
    function stopTick(){ if (tick) { clearInterval(tick); tick = null; } }

    function nextBlock() {
      timerIdx += 1;
      if (!activeRoutine || timerIdx >= activeRoutine.blocks.length) {
        running = false; stopTick(); remaining = 0;
        elBtnToggle.textContent = '‚ñ∂Ô∏è Start';
        return;
      }
      const blk = activeRoutine.blocks[timerIdx];
      remaining = blk.secs;
    }

    function resetTimer() {
      if (!activeRoutine) return;
      timerIdx = 0; remaining = activeRoutine.blocks[0]?.secs || 0; running = false; stopTick();
      elBtnToggle.textContent = '‚ñ∂Ô∏è Start';
      updateTimerUI();
    }

    function updateTimerUI() {
      if (!activeRoutine) return;
      const blk = activeRoutine.blocks[timerIdx];
      const isExercise = blk?.type === 'exercise';
      elTimerCurrent.textContent = isExercise ? (exercises.find(e => e.id === blk.exerciseId)?.name || '√úbung') : 'Pause';
      elTimerStep.textContent = `Schritt ${timerIdx + 1} / ${activeRoutine.blocks.length}`;
      elTimerRemaining.textContent = Math.max(0, remaining) + 's';

      elTimerVideo.innerHTML = ''; elTimerVideo.classList.add('hidden');
      if (isExercise) {
        const ex = exercises.find(e => e.id === blk.exerciseId);
        if (ex && ex.videoUrl) {
          elTimerVideo.classList.remove('hidden');
          const wrap = document.createElement('div'); wrap.className = 'aspect-video';
          wrap.innerHTML = `<iframe src="${ex.videoUrl}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>`;
          elTimerVideo.appendChild(wrap);
        }
      }
    }

    elBtnToggle.onclick = () => { if (!activeRoutine) return;
      running = !running; elBtnToggle.textContent = running ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Start'; if (running) startTick();
    };
    elBtnReset.onclick = resetTimer;

    // ----- Add/Edit Modal -----
    const modal = document.getElementById('modal');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const fName = document.getElementById('f-name');
    const fDiff = document.getElementById('f-diff');
    const fGroups = document.getElementById('f-groups');
    const fEquip = document.getElementById('f-equip');
    const fVideo = document.getElementById('f-video');
    const fCues = document.getElementById('f-cues');
    const fSteps = document.getElementById('f-steps');
    const fSave = document.getElementById('f-save');
    let editingId = null;

    function renderGroupChipsForForm(selected = []) {
      fGroups.innerHTML = '';
      const chosen = new Set(selected);
      ['Beine','Arme','R√ºcken','Brust','Core'].forEach(g => {
        const b = document.createElement('button');
        b.className = 'chip' + (chosen.has(g) ? ' active' : '');
        b.textContent = g;
        b.onclick = (ev) => { ev.preventDefault(); if (chosen.has(g)) { chosen.delete(g); b.classList.remove('active'); } else { chosen.add(g); b.classList.add('active'); } };
        fGroups.appendChild(b);
      });
      return () => Array.from(chosen);
    }
    let getSelectedGroups = renderGroupChipsForForm();

    function openAddModal(){
      editingId = null;
      modalTitle.textContent = 'Neue √úbung anlegen';
      fName.value=''; fEquip.value='Keine'; fVideo.value=''; fCues.value=''; fSteps.value=''; fDiff.value='Einsteiger'; 
      getSelectedGroups = renderGroupChipsForForm([]);
      modal.showModal();
    }
    function openEditModal(id){
      const ex = exercises.find(x => x.id === id); if (!ex) return;
      editingId = id;
      modalTitle.textContent = '√úbung bearbeiten';
      fName.value = ex.name; fEquip.value = ex.equipment; fVideo.value = ex.videoUrl; fDiff.value = ex.difficulty;
      fCues.value = (ex.cues||[]).join('\n'); fSteps.value = (ex.steps||[]).join('\n');
      getSelectedGroups = renderGroupChipsForForm(ex.groups||[]);
      modal.showModal();
    }

    document.getElementById('btnAdd').onclick = openAddModal;
    modalClose.onclick = (e) => { e.preventDefault(); modal.close(); };

    fSave.onclick = (e) => {
      e.preventDefault();
      const name = fName.value.trim(); if (!name) { alert('Bitte Namen eingeben'); return; }
      const payload = {
        name,
        groups: getSelectedGroups(),
        difficulty: fDiff.value,
        equipment: fEquip.value || 'Keine',
        videoUrl: toEmbed(fVideo.value.trim()),
        cues: fCues.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
        steps: fSteps.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean),
      };
      if (editingId) {
        // Update existing (keep id to not break routines)
        exercises = exercises.map(x => x.id === editingId ? { ...x, ...payload } : x);
      } else {
        const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'_').slice(0,40);
        if (exercises.some(x => x.id === id)) { alert('Diese √úbung existiert bereits.'); return; }
        exercises.push({ id, ...payload });
      }
      save(LS_EX, exercises); renderExercises(); renderFilters(); renderExerciseCheckboxes(); modal.close();
    };

    // ----- Import/Export -----
    elBtnExport.onclick = () => {
      const payload = { exercises, routines, log: logs };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'markus_workouts.json'; a.click(); URL.revokeObjectURL(url);
    };
    elFileImport.onchange = (e) => {
      const f = e.target.files?.[0]; if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const data = JSON.parse(reader.result);
          if (Array.isArray(data.exercises)) exercises = data.exercises;
          if (Array.isArray(data.routines)) routines = data.routines;
          if (data.log && typeof data.log === 'object') logs = data.log;
          save(LS_EX, exercises); save(LS_RT, routines); save(LS_LOG, logs);
          renderExercises(); renderRoutines(); renderFilters(); renderExerciseCheckboxes();
        } catch { alert('Konnte JSON nicht lesen'); }
      };
      reader.readAsText(f);
      e.target.value = '';
    };

    // ----- Search -----
    elSearch.oninput = renderExercises;

    // ----- Filter Drawer events -----
    elBtnFilter.onclick = () => { renderFilters(); elDrawer.classList.add('open'); };
    elCloseDrawer.onclick = () => elDrawer.classList.remove('open');
    elDrawer.addEventListener('click', (e) => { if (e.target === elDrawer) elDrawer.classList.remove('open'); });
    elResetFilters.onclick = resetFilters;

    // ----- Calendar -----
    let calYear, calMonth; // month: 0-11
    function openCalendar(date = new Date()){
      calYear = date.getFullYear();
      calMonth = date.getMonth();
      renderCalendar();
      calModal.showModal();
    }
    function renderCalendar(){
      const first = new Date(calYear, calMonth, 1);
      const startDay = (first.getDay() + 6) % 7; // Mo=0
      const daysInMonth = new Date(calYear, calMonth+1, 0).getDate();
      const prevDays = new Date(calYear, calMonth, 0).getDate();
      calTitle.textContent = first.toLocaleDateString('de-DE', { month:'long', year:'numeric' });
      calGrid.innerHTML = '';

      // create 42 cells (6 rows * 7 cols)
      for (let i=0; i<42; i++){
        const cell = document.createElement('div'); cell.className = 'cal-cell';
        let dayNum, thisMonth = true, date;
        if (i < startDay) { dayNum = prevDays - startDay + i + 1; thisMonth = false; date = new Date(calYear, calMonth-1, dayNum); }
        else if (i >= startDay + daysInMonth) { dayNum = i - startDay - daysInMonth + 1; thisMonth = false; date = new Date(calYear, calMonth+1, dayNum); }
        else { dayNum = i - startDay + 1; date = new Date(calYear, calMonth, dayNum); }
        const ds = date.toISOString().slice(0,10);
        const header = document.createElement('div'); header.className = 'flex items-center justify-between mb-1';
        const n = document.createElement('div'); n.textContent = dayNum; n.className = 'font-semibold ' + (thisMonth ? '' : 'cal-muted');
        header.appendChild(n);
        if (logs[ds] && logs[ds].length){
          const sumMin = logs[ds].reduce((a,b)=>a+(b.duration||0),0);
          const badge = document.createElement('span'); badge.className = 'badge'; badge.textContent = sumMin + 'm';
          header.appendChild(badge);
        }
        cell.appendChild(header);
        // small list of exercise initials
        if (logs[ds] && logs[ds].length){
          const ul = document.createElement('div'); ul.className = 'text-xs text-[color:var(--muted)] line-clamp-2';
          const names = new Set();
          logs[ds].forEach(entry => (entry.exercises||[]).forEach(id => {
            const ex = exercises.find(e => e.id === id);
            if (ex) names.add(ex.name.split(' ')[0]);
          }));
          ul.textContent = Array.from(names).slice(0,3).join(', ');
          cell.appendChild(ul);
        }
        cell.onclick = () => openLogForDate(ds);
        calGrid.appendChild(cell);
      }
    }
    function openLogForDate(ds){
      logTitle.textContent = 'Training am ' + ds.replace(/-/g,'.');
      logDate.value = ds;
      logDuration.value = '';
      logCalories.value = '';
      renderExerciseCheckboxes();
      renderExistingForDate(ds);
      logModal.showModal();
    }
    function renderExerciseCheckboxes(){
      logExerciseList.innerHTML='';
      exercises.forEach(e => {
        const id = 'chk_' + e.id;
        const row = document.createElement('label'); row.className='flex items-center gap-2 py-1 cursor-pointer';
        row.innerHTML = `<input type="checkbox" id="${id}"><span>${e.name}</span>`;
        logExerciseList.appendChild(row);
      });
    }
    function renderExistingForDate(ds){
      logExisting.innerHTML = '';
      const arr = logs[ds] || [];
      if (!arr.length) { logExisting.textContent = 'Noch keine Eintr√§ge.'; return; }
      arr.forEach((entry, idx) => {
        const names = (entry.exercises||[]).map(id => exercises.find(e=>e.id===id)?.name || id).join(', ');
        const wrap = document.createElement('div'); wrap.className = 'flex items-center justify-between p-2 rounded-lg border border-[color:var(--border)]';
        wrap.innerHTML = `<div><strong>${entry.duration||0} Min</strong> ¬∑ ${names}${entry.calories ? ' ¬∑ ' + entry.calories + ' kcal' : ''}</div>`;
        const del = document.createElement('button'); del.className='btn btn-danger'; del.textContent='L√∂schen';
        del.onclick = () => { if (!confirm('Eintrag l√∂schen?')) return; logs[ds].splice(idx,1); if (!logs[ds].length) delete logs[ds]; save(LS_LOG, logs); renderExistingForDate(ds); renderCalendar(); };
        wrap.appendChild(del);
        logExisting.appendChild(wrap);
      });
    }

    elBtnCalendar.onclick = () => openCalendar(new Date());
    calPrev.onclick = () => { calMonth -= 1; if (calMonth < 0) { calMonth = 11; calYear -= 1; } renderCalendar(); };
    calNext.onclick = () => { calMonth += 1; if (calMonth > 11) { calMonth = 0; calYear += 1; } renderCalendar(); };
    calClose.onclick = () => calModal.close();
    logClose.onclick = (e) => { e.preventDefault(); logModal.close(); };

    logSave.onclick = (e) => {
      e.preventDefault();
      const ds = logDate.value;
      if (!ds) { alert('Bitte Datum w√§hlen'); return; }
      const duration = parseInt(logDuration.value || '0', 10);
      const calories = logCalories.value ? parseInt(logCalories.value, 10) : null;
      const selected = Array.from(logExerciseList.querySelectorAll('input[type=checkbox]:checked')).map(ch => ch.id.replace('chk_',''));
      if (!selected.length && duration===0) { alert('W√§hle mindestens eine √úbung oder gib eine Dauer an.'); return; }
      const arr = logs[ds] || (logs[ds] = []);
      arr.push({ exercises: selected, duration, calories, ts: Date.now() });
      save(LS_LOG, logs);
      renderExistingForDate(ds); renderCalendar();
      logDuration.value=''; logCalories.value='';
      logExerciseList.querySelectorAll('input').forEach(ch => ch.checked=false);
    };

    // ----- Init -----
    renderExercises(); renderRoutines(); renderFilters(); renderExerciseCheckboxes();

    // ----- PWA: Service Worker -----
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js'); });
    }
  </script>
</body>
</html>
